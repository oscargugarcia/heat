% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/aggregation.R
\name{trans_spatial_agg}
\alias{trans_spatial_agg}
\title{Transform and Spatially Aggregate Environmental Rasters with Batch Processing and Memory Management}
\usage{
trans_spatial_agg(
  env_rast_list,
  sec_weight_rast_list,
  polygons,
  buffered_extent,
  trans_type,
  trans_fun,
  checked_trans_args,
  spatial_agg_args,
  poly_id_col,
  weighting_periods,
  save_path,
  sec_weights = TRUE,
  max_cells = 3e+07,
  save_batch_output = TRUE,
  overwrite_batch_output = FALSE
)
}
\arguments{
\item{env_rast_list}{A list of environmental raster subsets, one per weighting period.}

\item{sec_weight_rast_list}{A list of secondary weight raster layers (SpatRaster objects), one per weighting period.
Each element should be a single-layer or multi-layer SpatRaster corresponding to that period.
Use NULL if sec_weights = FALSE.}

\item{polygons}{An sf object containing the spatial polygons over which aggregation is performed.}

\item{buffered_extent}{A buffered extent used to crop the secondary weight rasters.}

\item{trans_type}{A character string indicating the type of transformation.}

\item{trans_fun}{A transformation function to be applied to each environmental raster subset.}

\item{checked_trans_args}{A list of pre-validated arguments for the transformation function.}

\item{spatial_agg_args}{A list of arguments to pass to \code{exact_extract} for spatial aggregation.}

\item{poly_id_col}{The name of the polygon identifier column in the polygons object.}

\item{weighting_periods}{A data structure containing information for each weighting period.}

\item{save_path}{Optional character string specifying the output directory. Required if save_batch_output = TRUE.}

\item{sec_weights}{Logical flag indicating whether to use secondary weight rasters (TRUE) or area weights (FALSE).}

\item{max_cells}{Numeric maximum allowed number of cells for processing a raster subset at once.}

\item{save_batch_output}{Logical indicating whether to save intermediate batch outputs to disk for memory efficiency (default: TRUE).}

\item{overwrite_batch_output}{Logical indicating whether to overwrite existing batch files. When FALSE, existing files
are validated to ensure layer counts match current processing parameters (default: FALSE).}
}
\value{
A data.table containing the final spatial aggregation results.
}
\description{
This function processes environmental raster data over multiple weighting periods by applying a specified transformation
and spatially aggregating over polygons. When raster dimensions exceed limits, it splits processing into batches
and can save intermediate outputs to disk for memory efficiency. When overwrite_batch_output is FALSE, it checks
for existing batch files and validates that the number of layers matches the current processing parameters.

All batch files are kept until the end of processing, allowing the function to resume if it fails partway through.
Even periods that fit in a single batch are saved to disk for consistency.
}
\details{
When \code{overwrite_batch_output = FALSE}, the function checks for existing batch files with the naming convention:
\code{period_XXX_batch_XXX_nlayer_XXXX.rds}. If a file exists but has a different number of layers than expected
(indicating changed max_cells parameters), an error is thrown requiring either starting from scratch or using
consistent max_cells values.

Batch files are saved in RDS format with compression disabled for optimal read/write speed. All batch files are
retained until final processing is complete, allowing the function to resume from where it left off if interrupted.

Secondary weight rasters must be in EPSG:4326 coordinate system, otherwise an error will be thrown.
}
\examples{
\dontrun{
  result <- trans_spatial_agg(env_rast_list, sec_weight_rast_list, polygons, buffered_extent,
                              trans_type, trans_fun, checked_trans_args, spatial_agg_args, 
                              poly_id_col = "poly_id", weighting_periods, save_path, 
                              sec_weights = TRUE, max_cells = 3e7)
}
}
