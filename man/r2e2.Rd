% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/r2e2.R
\name{r2e2}
\alias{r2e2}
\title{Raster to Environment Exposures (r2e2) Pipeline}
\usage{
r2e2(
  env_rast,
  geometry,
  geom_id_col = NULL,
  trans_type,
  degree = NULL,
  breaks = NULL,
  knots = NULL,
  trans_args = list(),
  daily_agg_fun = "none",
  out_temp_res,
  temp_agg_fun = "mean",
  sec_weight_rast = NULL,
  start_date = NULL,
  end_date = NULL,
  spatial_agg_args = NULL,
  save_path = NULL,
  out_format = "all",
  max_cells = 3e+07,
  metadata = NULL,
  save_console_output = FALSE,
  save_batch_output = FALSE,
  overwrite_batch_output = FALSE,
  compression = "zstd",
  validation = TRUE,
  validation_var = "degree_1",
  validation_var_name = "Temperature (C)",
  verbose = 1
)
}
\arguments{
\item{env_rast}{Either a character string specifying the directory path to environmental
rasters, OR a SpatRaster object containing the environmental data.
Layer names must be in date format (e.g., "YYYY-MM-DD").}

\item{geometry}{Either a character string specifying the file path to a spatial geometry file
(e.g., shapefile, geopackage), OR an sf/SpatVector object containing
polygons or points for spatial aggregation.}

\item{geom_id_col}{A character string representing the column name of the unique ID
in the geometry dataset (e.g., "GEOID"). If NULL, a row_index
column will be created and used as the geometry ID,
and all other columns are kept in the output.}

\item{trans_type}{A character string indicating the type of transformation to apply
to the raster data (e.g., "polynomial", "bin", "natural_spline", "b_spline", "none").}

\item{degree}{An integer specifying the polynomial degree (required if trans_type = "polynomial").}

\item{breaks}{A numeric vector specifying the bin breakpoints (required if trans_type = "bin").}

\item{knots}{A numeric vector specifying the knot positions for splines
(required if trans_type = "natural_spline" or "b_spline").}

\item{trans_args}{A list of additional custom parameters to be passed to the transformation
function (e.g., Boundary.knots for splines). Optional. The provided degree, breaks, or knots
parameters will be automatically added to this list, depending on the trans_type.}

\item{daily_agg_fun}{A character string specifying the subdaily aggregation function for hourly data.
Options are "none" (default, no aggregation), "mean", or "sum".
If the input data is hourly or subdaily, this aggregates to daily values first.
If "none" or input data is already daily/monthly/yearly, no subdaily aggregation is performed.}

\item{out_temp_res}{A character string specifying the output temporal resolution.
Options are "daily", "monthly", or "yearly" (required).}

\item{temp_agg_fun}{A character string specifying the temporal aggregation function.
Options are "mean" (default) or "sum". If the output temporal resolution is the same as
the input (daily), no temporal aggregation is performed.}

\item{sec_weight_rast}{Either a character string specifying the directory path to secondary
weight rasters, OR a SpatRaster object containing the weight data.
If NULL (default), no secondary weighting is applied.
Layer names must be in date format.}

\item{start_date}{Optional character string or Date object specifying the start date for
the analysis (e.g., "2020-01-01"). The environmental raster will be filtered
to begin at this date. If NULL (default), uses the first date available in the
environmental raster.}

\item{end_date}{Optional character string or Date object specifying the end date for
the analysis (e.g., "2020-12-31"). The environmental raster will be filtered
to end at this date. If NULL (default), uses the last date available in the
environmental raster.}

\item{spatial_agg_args}{A list containing any specific arguments related to spatial
aggregation, including optional append_cols for additional columns
to include in output (default is NULL).}

\item{save_path}{Optional character string specifying the output directory for storing
results. If NULL (default), results will be returned without saving to disk.
When provided, area weights are automatically saved.}

\item{out_format}{Character string specifying the output format. Options are:
- "all" (default): Returns and saves both wide and long formats
- "wide": Returns and saves only wide format (time steps as columns)
- "long": Returns and saves only long format (time steps as rows)
Wide format has one row per polygon with time steps as separate columns.
Long format has one row per polygon-time combination with time in rows.}

\item{max_cells}{A numeric value representing the maximum number of raster cells that
can be processed at once (default is 3e7).}

\item{metadata}{A list containing metadata related to the dataset and analysis,
such as variable names, descriptions, and additional identifiers (default is NULL).}

\item{save_console_output}{A logical value indicating whether to save console output
to a log file (default is FALSE).}

\item{save_batch_output}{Logical indicating whether to save intermediate batch outputs to disk for memory efficiency (default: FALSE).}

\item{overwrite_batch_output}{Logical indicating whether to overwrite existing batch files. When FALSE, existing files
are validated to ensure layer counts match current processing parameters (default: FALSE).}

\item{compression}{A character string specifying the compression algorithm for parquet
files (default is 'zstd').}

\item{validation}{A logical value indicating whether to run validation checks
for data quality control (default is TRUE).}

\item{validation_var}{The name of the transformation variable to be used in validation plots.
(default is 'degree_1' but if not found, it will use the first detected transformation variable)}

\item{validation_var_name}{A character string describing the transformation variable
for plot labels (default is "Temperature (C)")}

\item{verbose}{Integer controlling message verbosity: 0 = silent, 1 = concise progress messages,
2 = detailed messages (default: 1). This applies to both the r2e2 pipeline and validation checks.}
}
\value{
A list containing the processed data frames:
- spatial_agg: Daily aggregated data in wide format (time steps as columns, NULL if out_format = "long")
- spatial_agg_long: Daily aggregated data in long format (time steps as rows, NULL if out_format = "wide" or temporal resolution is daily)
- temp_agg_wide: Temporally aggregated data in wide format (time steps as columns, NULL if out_format = "long" or temporal resolution is daily)
- temp_agg_long: Temporally aggregated data in long format (time steps as rows, NULL if out_format = "wide")
- area_weights: Area weights data frame (always included)
Results are also saved directly to the specified output directory in parquet format when save_path is provided.
}
\description{
This function runs an aggregation pipeline that processes environmental raster data
and polygon datasets to perform spatial and temporal aggregations. It loads the necessary
data, applies specified transformations, and outputs aggregated results in both wide
and long formats. The function also allows for the calculation of area weights if
specified.
}
\details{
The function performs the following main operations:
\itemize{
\item Loads spatial and environmental data.
\item Processes and applies transformations to raster data.
\item Executes spatial and temporal aggregations with optional secondary weighting.
\item Saves the results in both wide and long formats along with optional area weights.
}
}
